<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="vibe.api.repository.OrderMapper">

    <!-- 주문서 데이터 조회 ResultMap -->
    <resultMap id="OrderFormResultMap" type="vibe.api.dto.response.OrderFormResponse">
        <id column="MEMBER_NO"/>
        <association property="memberInfo" javaType="vibe.api.dto.response.OrderFormResponse$MemberInfo">
            <result property="name" column="NAME"/>
            <result property="phone" column="PHONE"/>
            <result property="email" column="EMAIL"/>
            <result property="points" column="POINTS"/>
        </association>
        <collection property="cartList" ofType="vibe.api.dto.response.OrderFormResponse$CartItem">
            <id property="cartId" column="CART_ID"/>
            <result property="productNo" column="PRODUCT_NO"/>
            <result property="productName" column="PRODUCT_NAME"/>
            <result property="qty" column="QTY"/>
            <result property="price" column="PRICE"/>
        </collection>
    </resultMap>

    <!-- 주문서 데이터 조회 -->
    <select id="selectOrderFormData" resultMap="OrderFormResultMap">
        SELECT /* OrderMapper.selectOrderFormData */
               M.MEMBER_NO
             , M.NAME
             , M.PHONE
             , M.EMAIL
             , M.POINTS
             , C.CART_ID
             , C.PRODUCT_NO
             , P.PRODUCT_NAME
             , C.QTY
             , P.PRICE
          FROM MEMBER M
          LEFT JOIN CART C ON M.MEMBER_NO = C.MEMBER_NO
          LEFT JOIN PRODUCT P ON C.PRODUCT_NO = P.PRODUCT_NO
         WHERE M.MEMBER_NO = #{memberNo}
           AND C.CART_ID IN
               <foreach collection="cartIdList" item="cartId" open="(" separator="," close=")">
                   #{cartId}
               </foreach>
         ORDER BY C.CREATED_AT DESC
    </select>

    <!-- 주문번호 채번 -->
    <select id="selectNextOrderNo" resultType="string">
        SELECT /* OrderMapper.selectNextOrderNo */
               'O' || TO_CHAR(CURRENT_DATE, 'YYYYMMDD') || LPAD(NEXTVAL('SEQ_ORDER_NO')::TEXT, 6, '0')
    </select>

    <!-- 주문 내역 조회 ResultMap -->
    <resultMap id="OrderHistoryResultMap" type="vibe.api.dto.response.OrderHistoryResponse">
        <id property="orderNo" column="ORDER_NO"/>
        <result property="orderDate" column="ORDER_DATE"/>
        <result property="totalAmount" column="TOTAL_AMOUNT"/>
        <result property="status" column="STATUS"/>
        <collection property="items" ofType="vibe.api.dto.response.OrderHistoryResponse$OrderHistoryItem">
            <id property="orderSeq" column="ORDER_SEQ"/>
            <result property="productNo" column="PRODUCT_NO"/>
            <result property="productName" column="PRODUCT_NAME"/>
            <result property="price" column="PRICE"/>
            <result property="qty" column="QTY"/>
            <result property="cancelQty" column="CANCEL_QTY"/>
        </collection>
    </resultMap>

    <!-- 주문 내역 조회 -->
    <select id="selectOrderHistoryList" parameterType="string" resultMap="OrderHistoryResultMap">
        SELECT /* OrderMapper.selectOrderHistoryList */
               OB.ORDER_NO
             , TO_CHAR(OB.ORDER_DATETIME, 'YYYY-MM-DD') AS ORDER_DATE
             , COALESCE(SUM(OP.PRICE * OD.ORDER_QTY), 0) AS TOTAL_AMOUNT
             , CASE
                   WHEN SUM(OD.ORDER_QTY) = SUM(OD.CANCEL_QTY) THEN 'CANCEL'
                   ELSE 'COMPLETE'
               END AS STATUS
             , OD.ORDER_SEQ
             , OD.PRODUCT_NO
             , OP.PRODUCT_NAME
             , OP.PRICE
             , OD.ORDER_QTY AS QTY
             , OD.CANCEL_QTY
          FROM ORDER_BASE OB
         INNER JOIN ORDER_DETAIL OD ON OB.ORDER_NO = OD.ORDER_NO
         INNER JOIN ORDER_PRODUCT OP ON OB.ORDER_NO = OP.ORDER_NO AND OD.PRODUCT_NO = OP.PRODUCT_NO
         WHERE OB.MEMBER_NO = #{memberNo}
           AND OD.ORDER_TYPE = 'ORDER'
         GROUP BY OB.ORDER_NO, OB.ORDER_DATETIME, OD.ORDER_SEQ, OD.PRODUCT_NO, OP.PRODUCT_NAME, OP.PRICE, OD.ORDER_QTY, OD.CANCEL_QTY
         ORDER BY OB.ORDER_DATETIME DESC, OD.ORDER_SEQ ASC
    </select>

    <!-- 주문 완료 조회 ResultMap -->
    <resultMap id="OrderCompleteResultMap" type="vibe.api.dto.response.OrderCompleteResponse">
        <id property="orderNo" column="ORDER_NO"/>
        <result property="orderDate" column="ORDER_DATE"/>
        <result property="totalAmount" column="TOTAL_AMOUNT"/>
        <result property="paymentStatus" column="PAYMENT_STATUS"/>
        <collection property="items" ofType="vibe.api.dto.response.OrderCompleteResponse$OrderCompleteItem">
            <id column="ORDER_SEQ"/>
            <result property="productName" column="PRODUCT_NAME"/>
            <result property="price" column="PRICE"/>
            <result property="qty" column="QTY"/>
        </collection>
        <collection property="payments" ofType="vibe.api.dto.response.OrderCompleteResponse$PaymentInfo">
            <id column="PAYMENT_NO"/>
            <result property="method" column="PAYMENT_METHOD"/>
            <result property="amount" column="PAYMENT_AMOUNT"/>
        </collection>
    </resultMap>

    <!-- 주문 완료 조회 -->
    <select id="selectOrderCompleteData" parameterType="string" resultMap="OrderCompleteResultMap">
        SELECT /* OrderMapper.selectOrderCompleteData */
               OB.ORDER_NO
             , TO_CHAR(OB.ORDER_DATETIME, 'YYYY-MM-DD HH24:MI') AS ORDER_DATE
             , (SELECT COALESCE(SUM(OP2.PRICE * OD2.ORDER_QTY), 0)
                  FROM ORDER_DETAIL OD2
                 INNER JOIN ORDER_PRODUCT OP2 ON OD2.ORDER_NO = OP2.ORDER_NO AND OD2.PRODUCT_NO = OP2.PRODUCT_NO
                 WHERE OD2.ORDER_NO = OB.ORDER_NO
                   AND OD2.ORDER_TYPE = 'ORDER') AS TOTAL_AMOUNT
             , 'SUCCESS' AS PAYMENT_STATUS
             , OD.ORDER_SEQ
             , OP.PRODUCT_NAME
             , OP.PRICE
             , OD.ORDER_QTY AS QTY
             , P.PAYMENT_NO
             , P.PAYMENT_METHOD
             , P.PAYMENT_AMOUNT
          FROM ORDER_BASE OB
         INNER JOIN ORDER_DETAIL OD ON OB.ORDER_NO = OD.ORDER_NO
         INNER JOIN ORDER_PRODUCT OP ON OB.ORDER_NO = OP.ORDER_NO AND OD.PRODUCT_NO = OP.PRODUCT_NO
          LEFT JOIN PAYMENT P ON OB.ORDER_NO = P.ORDER_NO AND P.PAYMENT_TYPE = 'PAYMENT'
         WHERE OB.ORDER_NO = #{orderNo}
           AND OD.ORDER_TYPE = 'ORDER'
         ORDER BY OD.ORDER_SEQ ASC, P.PAYMENT_NO ASC
    </select>

    <!-- 주문 상세 조회 ResultMap -->
    <resultMap id="OrderDetailResultMap" type="vibe.api.dto.response.OrderDetailResponse">
        <id property="orderNo" column="ORDER_NO"/>
        <result property="orderDate" column="ORDER_DATE"/>
        <association property="orderer" javaType="vibe.api.dto.response.OrderDetailResponse$OrdererInfo">
            <result property="name" column="ORDERER_NAME"/>
            <result property="phone" column="ORDERER_PHONE"/>
            <result property="email" column="ORDERER_EMAIL"/>
        </association>
        <collection property="items" ofType="vibe.api.dto.response.OrderDetailResponse$OrderDetailItem">
            <id property="orderSeq" column="ORDER_SEQ"/>
            <result property="productNo" column="PRODUCT_NO"/>
            <result property="productName" column="PRODUCT_NAME"/>
            <result property="price" column="PRICE"/>
            <result property="qty" column="QTY"/>
            <result property="cancelQty" column="CANCEL_QTY"/>
        </collection>
        <collection property="payments" ofType="vibe.api.dto.response.OrderDetailResponse$PaymentInfo">
            <id column="PAYMENT_NO"/>
            <result property="pgType" column="PG_TYPE"/>
            <result property="method" column="PAYMENT_METHOD"/>
            <result property="amount" column="PAYMENT_AMOUNT"/>
        </collection>
    </resultMap>

    <!-- 주문 상세 조회 -->
    <select id="selectOrderDetail" parameterType="string" resultMap="OrderDetailResultMap">
        SELECT /* OrderMapper.selectOrderDetail */
               OB.ORDER_NO
             , TO_CHAR(OB.ORDER_DATETIME, 'YYYY-MM-DD HH24:MI') AS ORDER_DATE
             , OB.ORDERER_NAME
             , OB.ORDERER_PHONE
             , OB.ORDERER_EMAIL
             , OD.ORDER_SEQ
             , OD.PRODUCT_NO
             , OP.PRODUCT_NAME
             , OP.PRICE
             , OD.ORDER_QTY AS QTY
             , OD.CANCEL_QTY
             , P.PAYMENT_NO
             , P.PG_TYPE AS PG_TYPE
             , P.PAYMENT_METHOD
             , P.PAYMENT_AMOUNT
          FROM ORDER_BASE OB
         INNER JOIN ORDER_DETAIL OD ON OB.ORDER_NO = OD.ORDER_NO
         INNER JOIN ORDER_PRODUCT OP ON OB.ORDER_NO = OP.ORDER_NO AND OD.PRODUCT_NO = OP.PRODUCT_NO
          LEFT JOIN PAYMENT P ON OB.ORDER_NO = P.ORDER_NO AND P.PAYMENT_TYPE = 'PAYMENT'
         WHERE OB.ORDER_NO = #{orderNo}
           AND OD.ORDER_TYPE = 'ORDER'
         ORDER BY OD.ORDER_SEQ ASC
    </select>

    <!-- 클레임번호 채번 -->
    <select id="selectNextClaimNo" resultType="string">
        SELECT /* OrderMapper.selectNextClaimNo */
               'C' || TO_CHAR(CURRENT_DATE, 'YYYYMMDD') || LPAD(NEXTVAL('SEQ_CLAIM_NO')::TEXT, 6, '0')
    </select>

    <!-- 주문번호로 회원번호 조회 -->
    <select id="selectMemberNoByOrderNo" parameterType="string" resultType="string">
        SELECT /* OrderMapper.selectMemberNoByOrderNo */
               MEMBER_NO
          FROM ORDER_BASE
         WHERE ORDER_NO = #{orderNo}
    </select>

    <!-- 주문의 최대 processSeq 조회 -->
    <select id="selectMaxProcessSeq" resultType="int">
        SELECT /* OrderMapper.selectMaxProcessSeq */
               COALESCE(MAX(PROCESS_SEQ), 0)
          FROM ORDER_DETAIL
         WHERE ORDER_NO = #{orderNo}
    </select>

    <!-- 특정 상품(orderSeq)의 최대 processSeq 조회 -->
    <select id="selectMaxProcessSeqByOrderSeq" resultType="int">
        SELECT /* OrderMapper.selectMaxProcessSeqByOrderSeq */
               COALESCE(MAX(PROCESS_SEQ), 0)
          FROM ORDER_DETAIL
         WHERE ORDER_NO = #{orderNo}
           AND ORDER_SEQ = #{orderSeq}
    </select>

</mapper>
